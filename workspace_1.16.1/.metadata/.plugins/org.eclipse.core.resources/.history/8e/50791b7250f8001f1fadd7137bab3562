/*
 * bms.h
 *
 *  Created on: Mar 2, 2025
 *      Author: apple
 */

#ifndef INC_BMS_H_
#define INC_BMS_H_

#ifdef __cplusplus
extern "C" {
#endif

#include "i2c.h"
#include "main.h"
#include <stdint.h>

#define BQ76905_I2C_ADDR 0x10	// Dirección I2C del BQ76905


// Enumeración de registros con nombres representativos
typedef enum {
    CONFIG_UPDATE       = 0x0090,
    CONFIG_EXIT         = 0x0092,
    VCELL_MODE          = 0x901B,
    ENABLED_PROT_A      = 0x9024,
    CELL_UV_THRESHOLD   = 0x902E,
    BATTERY_STATUS      = 0x12,
    ALARM_ENABLE        = 0x66,
    FET_CONTROL         = 0x68
} BQ76905_Registers;

// Estructura para almacenar datos de la batería
typedef struct {
    I2C_HandleTypeDef *hi2c;  // Interfaz I2C
    uint16_t cell1_voltage;
    uint16_t cell2_voltage;
    uint8_t alert_status_A;
    uint8_t fault_status_A;
    uint8_t alert_status_B;
    uint8_t fault_status_B;
    uint16_t battery_status;
} BQ76905_Device;



// Funciones para configurar y leer datos del BQ76905
HAL_StatusTypeDef BQ76905_WriteSubcommand(BQ76905_Device *bms, BQ76905_Registers subcmd);
HAL_StatusTypeDef BQ76905_WriteRegister(BQ76905_Device *bms, BQ76905_Registers reg, uint8_t *data, uint8_t len);
HAL_StatusTypeDef BQ76905_WriteChecksum(BQ76905_Device *bms, BQ76905_Registers reg, uint8_t *data, uint8_t len);
HAL_StatusTypeDef BQ76905_ReadRegister(BQ76905_Device *bms, BQ76905_Registers reg, uint8_t *rxData, uint8_t len);
void BQ76905_Configure(BQ76905_Device *bms);
void BQ76905_ReadData(BQ76905_Device *bms);





#ifdef __cplusplus
}
#endif

#endif /* INC_BMS_H_ */
