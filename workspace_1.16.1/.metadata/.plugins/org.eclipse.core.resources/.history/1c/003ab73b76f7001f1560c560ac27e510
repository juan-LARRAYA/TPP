/*
 * mppt.c
 *
 *  Created on: Mar 2, 2025
 *      Author: apple
 */

#include "mppt.h"
#include "adc.h"
#include "tim.h"


// Definir las estructuras para cada eje


void updateMPPT(MPPT_Channel *mppt) {
    // Leer valores de voltaje y corriente del ADC
    mppt->voltage = readADC(mppt->hadc, mppt->v_channel);
    mppt->current = readADC(mppt->hadc, mppt->i_channel);

    // Calcular potencia
    mppt->power = mppt->voltage * mppt->current;

    // Aplicar algoritmo MPPT
    mppt(mppt->dutyCycle, &mppt->power, &mppt->prevPower);

    // Actualizar el PWM en el canal correspondiente
    __HAL_TIM_SET_COMPARE(mppt->htim, mppt->tim_channel, mppt->dutyCycle);
}


void updateMPPT(ADC_HandleTypeDef *hadc, uint32_t v_channel, uint32_t i_channel,
                float *voltage, float *current, float *power, float *prevPower,
                uint8_t *dutyCycle, TIM_HandleTypeDef *htim, uint32_t tim_channel) {

    // Leer valores de voltaje y corriente del ADC
    *voltage = readADC(hadc, v_channel);
    *current = readADC(hadc, i_channel);

    // Calcular potencia
    *power = (*voltage) * (*current);

    // Aplicar algoritmo MPPT
    mppt(dutyCycle, power, prevPower);

    // Actualizar el PWM del canal correspondiente
    __HAL_TIM_SET_COMPARE(htim, tim_channel, *dutyCycle);
}
